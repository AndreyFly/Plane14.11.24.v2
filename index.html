<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self' blob: data: https://*.vk.com;
        script-src 'self' 'unsafe-inline' 'unsafe-eval' blob: https://*.vk.com;
        style-src 'self' 'unsafe-inline';
        frame-src 'self' https://*.vk.com;
        worker-src 'self' blob:;
    ">
    <style>
        html, body { 
            margin: 0; 
            padding: 0; 
            width: 100%; 
            height: 100%;
            overflow: hidden;
        }
        #unity-container { 
            position: absolute;
            width: 100%;
            height: 100%;
        }
        #unity-canvas {
            width: 100%;
            height: 100%;
            background: #231F20;
        }
    </style>
</head>
<body>
    <div id="unity-container">
        <canvas id="unity-canvas"></canvas>
    </div>
    <script>
    // Проверка загрузки в iframe VK
    const isVKFrame = (() => {
        try {
            return window.parent !== window && /vk\.com/i.test(window.parent.location.hostname);
        } catch (e) {
            return false;
        }
    })();

    // Адаптивный размер canvas
    function resizeCanvas() {
        const canvas = document.getElementById('unity-canvas');
        if (!canvas) return;
        
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        
        if (typeof unityInstance !== 'undefined') {
            unityInstance.SetFullscreen(0);
            unityInstance.Quit().then(() => {
                unityInstance = null;
                loadUnity();
            });
        }
    }

    // Загрузка Unity
    function loadUnity() {
        const buildUrl = 'Build';
        const config = {
            dataUrl: buildUrl + '/WEB.data',
            frameworkUrl: buildUrl + '/WEB.framework.js',
            codeUrl: buildUrl + '/WEB.wasm',
            streamingAssetsUrl: 'StreamingAssets',
            companyName: 'YourCompany',
            productName: 'YourGame',
            productVersion: '1.0',
        };

        const script = document.createElement('script');
        script.src = config.frameworkUrl;
        script.onload = () => {
            createUnityInstance(document.getElementById('unity-canvas'), config)
                .then(instance => {
                    window.unityInstance = instance;
                    if (isVKFrame) {
                        document.body.style.overflow = 'hidden';
                        window.addEventListener('resize', resizeCanvas);
                        resizeCanvas();
                    }
                })
                .catch(err => {
                    console.error('Unity init error:', err);
                });
        };
        script.onerror = () => console.error('Failed to load Unity framework');
        document.body.appendChild(script);
    }

    // Инициализация
    if (isVKFrame) {
        window.addEventListener('message', (e) => {
            if (e.data === 'vk_init') loadUnity();
        });
        window.parent.postMessage('vk_ready', '*');
    } else {
        loadUnity();
    }
    </script>
</body>
</html>
